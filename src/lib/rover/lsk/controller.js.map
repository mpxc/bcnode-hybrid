{"version":3,"sources":["../../../src/rover/lsk/controller.es6"],"names":["inspect","require","LRUCache","lisk","Block","logging","errToString","RpcClient","blake2b","createUnifiedBlock","skip","LSK_GENESIS_DATE","Date","getMerkleRoot","block","transactions","length","blockSignature","txs","map","tx","id","reduce","acc","el","getAbsoluteTimestamp","blockTs","getTime","_createUnifiedBlock","obj","blockNumber","height","prevHash","previousBlock","blockHash","root","fee","totalFee","size","payloadLength","payloadHash","generator","generatorId","generatorPublicKey","confirmations","totalForged","timestamp","parseInt","version","all","t","push","txHash","marked","msg","setBlockchain","setHash","setPreviousHash","setTimestamp","setHeight","setMerkleRoot","Controller","constructor","config","_config","_logger","getLogger","__filename","_blockCache","max","maxAge","_otherCache","_liskApi","APIClient","createMainnetAPIClient","rovers","lsk","_rpc","init","debug","process","on","info","exit","e","error","cycle","hasAvailableNodes","blocks","get","limit","then","lastBlocks","lastBlock","has","set","unifiedBlock","rover","collectBlock","err","response","concat","JSON","stringify","toObject","catch","_intervalDescriptor","setInterval","pop","close","clearInterval"],"mappings":"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","file":"controller.js","sourcesContent":["/**\n * Copyright (c) 2017-present, blockcollider.org developers, All rights reserved.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\nimport type { Logger } from 'winston'\nconst { inspect } = require('util')\nconst LRUCache = require('lru-cache')\n// Depcricated library const lisk = require('lisk-js')\nconst lisk = require('lisk-elements')\n\nconst { Block } = require('../../protos/core_pb')\nconst logging = require('../../logger')\nconst { errToString } = require('../../helper/error')\nconst { RpcClient } = require('../../rpc')\nconst { blake2b } = require('../../utils/crypto')\nconst { createUnifiedBlock } = require('../helper')\n\nlet skip = []\n\n// type LiskBlock = { // eslint-disable-line no-undef\n//  id: string,\n//  height: number,\n//  previousBlock: string,\n//  transactions: Object[],\n//  totalFee: number,\n//  payloadHash: string,\n//  payloadLength: number,\n//  generatorId: string,\n//  generatorPublicKey: string,\n//  blockSignature: string,\n//  confirmations: number,\n//  totalForged: number,\n//  timestamp: number,\n//  version: string\n// }\n\nconst LSK_GENESIS_DATE = new Date('2016-05-24T17:00:00.000Z')\n\nconst getMerkleRoot = (block) => {\n  if (!block.transactions || (block.transactions.length === 0)) {\n    return blake2b(block.blockSignature)\n  }\n\n  const txs = block.transactions.map((tx) => tx.id)\n  return txs.reduce((acc, el) => blake2b(acc + el), '')\n}\n\nconst getAbsoluteTimestamp = (blockTs: number) => {\n  return ((LSK_GENESIS_DATE.getTime() / 1000 << 0) + blockTs) * 1000\n}\n\nfunction _createUnifiedBlock (block: Object): Block {\n  const obj = {\n    blockNumber: block.height,\n    prevHash: block.previousBlock,\n    blockHash: block.id,\n    root: getMerkleRoot(block),\n    fee: block.totalFee,\n    size: block.payloadLength,\n    payloadHash: block.payloadHash,\n    generator: block.generatorId,\n    generatorPublicKey: block.generatorPublicKey,\n    blockSignature: block.blockSignature,\n    confirmations: block.confirmations,\n    totalForged: block.totalForged,\n    timestamp: getAbsoluteTimestamp(parseInt(block.timestamp, 10)),\n    version: block.version,\n    transactions: block.transactions.reduce(\n      function (all, t) {\n        all.push({\n          txHash: t.id,\n          // inputs: t.inputs,\n          // outputs: t.outputs,\n          marked: false\n        })\n        return all\n      },\n      []\n    )\n  }\n\n  const msg = new Block()\n  msg.setBlockchain('lsk')\n  msg.setHash(obj.blockHash)\n  msg.setPreviousHash(obj.prevHash)\n  msg.setTimestamp(obj.timestamp)\n  msg.setHeight(obj.blockNumber)\n  msg.setMerkleRoot(obj.root)\n\n  return msg\n}\n\n/**\n * LSK Controller\n */\nexport default class Controller {\n  /* eslint-disable no-undef */\n  _blockCache: LRUCache<string, bool>;\n  _otherCache: LRUCache<string, bool>;\n  _rpc: RpcClient;\n  _logger: Logger;\n  _intervalDescriptor: IntervalID;\n  _config: Object;\n  _liskApi: Object;\n  /* eslint-enable */\n\n  constructor (config: Object) {\n    this._config = config\n    this._logger = logging.getLogger(__filename)\n    this._blockCache = new LRUCache({\n      max: 200,\n      maxAge: 1000 * 60 * 60\n    })\n    this._otherCache = new LRUCache({ max: 50 })\n    // this._liskApi = lisk.api(config.rovers.lsk)\n    // randomizeNodes: true\n    this._liskApi = lisk.APIClient.createMainnetAPIClient(config.rovers.lsk)\n    this._rpc = new RpcClient()\n  }\n\n  init () {\n    this._logger.debug('initialized')\n\n    process.on('disconnect', () => {\n      this._logger.info('Parent exited')\n      process.exit()\n    })\n\n    process.on('uncaughtException', (e) => {\n      this._logger.error(`Uncaught exception: ${errToString(e)}`)\n      process.exit(3)\n    })\n\n    const cycle = () => {\n      this._logger.info('LSK rover active connection: ' + this._liskApi.hasAvailableNodes())\n\n      return this._liskApi.blocks.get({ limit: 1 }).then(lastBlocks => {\n        /* eslint-disable */\n        try {\n        const lastBlock = lastBlocks.blocks[0]\n        this._logger.debug(`Collected new block with id: ${inspect(lastBlock.id)}`)\n\n        if (!this._blockCache.has(lastBlock.id)) {\n          this._blockCache.set(lastBlock.id, true)\n          this._logger.debug(`unseen block with id: ${inspect(lastBlock.id)} => using for BC chain`)\n\n          // getTransactionsForBlock(this._liskApi, lastBlock.id).then(transactions => {\n          // TODO decide if we want to use block with no transactions, there are such\n          lastBlock.transactions = []\n          // if (transactions !== undefined) {\n\n          const unifiedBlock = createUnifiedBlock(lastBlock, _createUnifiedBlock)\n\n          this._logger.debug('LSK Going to call this._rpc.rover.collectBlock()')\n          try {\n            this._rpc.rover.collectBlock(unifiedBlock, (err, response) => {\n              if (err) {\n                this._logger.error(`error while collecting block ${inspect(err)}`)\n                skip = skip.concat(['1', '1'])\n                return\n              }\n              this._logger.debug(`Collector Response: ${JSON.stringify(response.toObject(), null, 4)}`)\n            })\n          } catch (err) {\n            skip = skip.concat(['1', '1'])\n            this._logger.error(err)\n          }\n          // } else {\n          //  skip.push('1')\n          // }\n          // })\n        }\n        } catch (err) {\n          skip.push('1')\n          this._logger.error(err)\n        }\n      })\n        .catch((err) => {\n          skip.push('1')\n          this._logger.error(err)\n          this._logger.error('connection lsk network error')\n        })\n    }\n\n    this._logger.debug('tick')\n    this._intervalDescriptor = setInterval(() => {\n      if (skip.length > 0) {\n        this._logger.debug('skip')\n        skip.pop()\n      } else {\n        cycle().then(() => {\n          this._logger.debug('tick')\n        })\n      }\n    }, 5600)\n\n    // setInterval(function () {\n    //  lisk.api(liskOptions).getPeersList({}, function (error, success, response) {\n    //    if (error) {\n    //      console.trace(error)\n    //    } else {\n    //      var t = response.peers.reduce(function (all, a) {\n    //        if (all[a.height] == undefined) {\n    //          all[a.height] = 1\n    //        } else {\n    //          all[a.height]++\n    //        }\n    //        return all\n    //      }, {})\n\n    //      var tp = Object.keys(t).sort(function (a, b) {\n    //        if (t[a] > t[b]) {\n    //          return -1\n    //        }\n    //        if (t[a] < t[b]) {\n    //          return 1\n    //        }\n    //        return 0\n    //      })\n\n    //      log.debug('peer sample: ' + response.peers.length)\n    //      log.debug('probable lsk block heigh ' + tp[0])\n    //    }\n    //  })\n    // }, 60000)\n  }\n\n  close () {\n    this._intervalDescriptor && clearInterval(this._intervalDescriptor)\n  }\n}\n"]}